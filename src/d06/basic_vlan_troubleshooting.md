# 基本的 VLAN 故障排除

VLAN 属于一项很少需要故障排除的相当简单功能。咱们将看到的一些问题，主要是配置错误。我们将在第 15 天详细介绍二层的故障排除。一些常见问题包括下面这些：

- VLAN 间路由不工作：要检查交换机和路由器之间的链路是否设置正确，以及相关 VLAN 是否被放行及未被修剪（请参阅 [VTP 修剪]()）。`show interface trunk` 命令将提供所需信息。还有，要检查路由器的子接口是否配置了正确的封装及 VLAN，以及子接口的 IP 地址是否是主机的默认网关；
- 一些 VLAN 无法被创建出来：要检查交换机上的 VTP 模式是否设置为 `client`。当 VTP 模式为 `client` 时，VLAN 便无法得以创建。另一个重要因素，是交换机上所允许的 VLAN 数量。`show vtp status` 命令将提供所需的信息（请参阅下面的 [中继故障排除]() 与 [VTP]() 小节）；
- 同一 VLAN 中的主机无法到达对方：某个 VLAN 中的主机，必须有着属于同一子网的 IP 地址。当子网不同时，那么他们就将无法相互连接。另一个要考虑的因素，是这些主机是否连接到同一交换机。当他们没有连接到同一交换机时，那么就要确保交换机之间的中继链路工作正常，以及确保该 VLAN 未从放行清单中排除/修剪。`show interface trunk` 命令将显示有关中继链路的必要信息。


## VLAN 分配问题

一些小型环境中的网络，相对容易管理，因为要实现业务目标，只需有限数量的功能特性实现即可。然而，在企业环境中，咱们将不会使用一些小型工作组交换机与 SOHO 的设备。相反，咱们将使用一些能够通过提供大量高级功能，优化流量的高端设备。

一项在这类环境中可能配置的特殊特性，便是使用 VLAN 从逻辑上分隔不同的网络区域。当咱们遇到与某一特定 VLAN 相关的配置问题时，那么故障便会出现，并会成为难于排除的故障。解决此类问题的一种方式，就是分析交换机上的整个配置，并尝试找出问题所在。

VLAN 相关问题，通常会经由观察网络主机之间的连接缺失（如某名用户无法 `ping` 通某个服务器）发现，尽管一层看起来运行没有问题。VLAN 相关问题的一个重要特点便是，他们不会导致网络性能的任何下降。当咱们错误配置了某个 VLAN 时，连接就将直接无法工作，特别是考虑到他们通常会隔离 IP 子网，因此只有同一 VLAN 中的设备，才能相互通信。

排除 VLAN 问题的第一步，是查看设计阶段所开发的文档与逻辑图示，从而咱们可识别出每个 VLAN 的跨接区域，包括每个交换机上的相关设备及端口。下一步是要检查每个交换机的配置，并尝试通过将其与文档中的解决方案比较找出问题。

咱们还应检查 IP 分址方案。当咱们是静态地分配 IP 地址给设备时，那么咱们可能需要回头检查设备，确保其有着正确的 IP 地址及子网掩码组合。当 IP 分址方案方面有任何错误，比如将设备配置在错误的网络上，或以配置以错误的子网掩码/默认网关时，那么即使咱们在交换机上有着正确的 VLAN，咱们也会遇到连通性问题。

咱们还将需要确认交换机上的中继配置是否正确。当咱们有着多台交换机时，他们之间通常有一些上行链路，而 VLAN 就承载于这些上行链路上。这些交换机间的链路，通常就被配置为中继链路，以实现多个 VLAN 上的通信。当某一 VLAN 中的数据要从一个交换机发送到另一交换机时，那么这个 VLAN 就必须是中继组的一员，因此咱们还必须确保，中继链路两侧的交换机配置均设置正确。

最后，当咱们将某一设备迁移到另一 VLAN 时，咱们将必须同时修改交换机及该客户端，因为作为这次迁移的结果，这一客户端将有着某一不同子网中不同的 IP 地址。

当咱们依循了所有这些 VLAN 故障排除方法时，咱们就能确保在首次插入设备，或将设备从一个 VLAN 迁移至另一 VLAN 时，咱们将获得咱们所需的准确连接。

