# 基于拓扑的 CEF 交换

将数据包的预期目的地址与 IP 路由表匹配，需要路由器的 CPU 周期。一些企业路由器会包含数以万计的条目，并可将同样数量的传入数据包，与这些条目匹配。在使这一过程尽可能高效的尝试中，思科已创造出多种交换方法。第一种方法称为进程交换，他使用了已概述过的路由查找与最佳匹配方法。这种方法已使用快速交换得以改进。一个最近转发过的数据包的 IP 地址列表会由路由器生成，以及 IP 地址匹配的那些数据链路层头部也会被拷贝。而思科快速转发（Cisco Express Forwarding，CEF），则作为对快速交换的一项改进而被创造出来。CEF 默认运行在当前的一些思科路由器型号上。

## 思科快速转发（CEF）

CEF 运行于数据平面，是一种拓扑驱动的专有交换机制，其会创建一个与路由表（即控制平面）绑定的转发表。CEF 的开发，是要消除因基于流的交换，所用到首个数据包进程交换查找方法，而会遇到的性能损失。CEF 通过实现基于硬件的三层路由引擎用到的路由缓存，在收到任何与流量相关的数据包前，就包含硬件中三层交换机所需的所有信息，消除了这种性能损失。传统上存储在路由缓存中的信息，被存储在用于 CEF 交换的两个数据结构中。这两个数据结构，提供了高效数据包转发的优化查找，被称为转发信息库（Forwarding Information Base, FIB）和邻接数据表。

**注意**：重要的是要记住，即使在 CEF 下，只要有路由表的变化，CEF 的转发数据表也会被更新。在新的 CEF 条目创建时，数据包会在某条较慢交换路径上得以交换，比如使用进程交换。所有当前思科路由器型号，及当前 IOS 软件都用到了 CEF。

## 转发信息库（FIB）

CEF 使用 FIB 做出基于 IP 目的地前缀的交换决策。FIB 在概念上类似于路由表或信息库。他维护着一个包含在 IP 路由表中转发信息的镜像。换句话说，FIB 包含了路由表中的所有 IP 前缀。

当网络中的路由或拓扑改变发生时，IP 路由表会被更新，同时这些变化也会在 FIB 中得以反映。FIB 根据 IP 路由表中的信息，维护下一跳地址的信息。由于 FIB 条目与路由表条目之间，存在一对一的相关性，因此 FIB 包含所有已知路由，并消除了与诸如快速交换，与最佳交换等交换路径相关的路由缓存维护需求。

此外，由于 FIB 的查找表包含了存在于路由表中的所有已知路由，因此他消除了路由缓存维护，以及快速交换及进程交换的转发情形。这允许 CEF 比典型的按需缓存方案，更有效地交换流量。


## 邻接表

邻接表的创建，是要包含所直连的下一跳。所谓邻接节点，是指相距一跳（即直连的）的某个节点。邻接表是在邻接关系发现时产生的。一旦某个邻居成为邻接节点，那么称为 MAC 字符串或 MAC 重写的，将用于到达该邻接节点的数据链路层头部，即被创建出来并存储在该表中。在以太网的网段上，这一头部信息，便是按特定顺序排列的目的 MAC 地址、源 MAC 地址与 `EtherType` 。

某条路由一经解析，其便会指向某个相邻的下一跳。当某个邻接节点于邻接表中找到时，到该相应邻接节点的一个指针，即会缓存于 FIB 元素中。当存在同一目的地的多条路径时，到各个邻接节点的指针，就会被添加到实现了负载均衡的负载均衡数据结构。在一些前缀添加到 FIB 时，那些需要异常处理的前缀，会以特殊邻接节点加以缓存。

## 加速及分布式的 CEF

默认情况下，所有基于 CEF 的 Cisco Catalyst 交换机，都使用了某种中心化的三层交换引擎，其中某单个处理器作出了交换机上所有端口接收到的流量的三层交换决策。尽管 Cisco Catalyst 交换机上用到的三层交换引擎，提供了高性能，但在某些网络中，让单个的三层交换引擎，完成所有的三层交换，并未提供足够性能。为了解决这个问题，Cisco Catalyst 6500 系列交换机，允许经由使用专门转发硬件的 CEF 优化。这是使用加速的 CEF (aCEF) ，或分布式的 CEF (dCEF) 完成的。

所谓加速的 CEF，允许将 FIB 的一部分，分配给 Catalyst 6500 交换机上的功能线路卡模组。这允许流量转发决策，在本地线路卡上使用本地存储的缩减 CEF 数据表作出。在 FIB 条目未于该（本地）缓存找到的情况下，那么一些更多 FIB 信息的请求，即会发送到三层引擎。

所谓分布式的 CEF，指的是分布于安装在机架上多个线路卡的多个 CEF 表。在使用 dCEF 时，三层引擎（MSFC）维护着路由表并生成 FIB，FID 随后会被全部动态下载到每个线路卡，从而实现多个三层数据平面同时运行。

> **译注**：Multilayer Switch Feature Card, MSFC

总之，dCEF 与 aCEF 均属于实现了多个三层交换引擎的技术，这样一些三层交换便可被同时并行运行，从而提高整体系统性能。CEF 技术带来以下优势：


- 改进的性能 -- 与快速交换的路由缓存相比，CEF 属于较少的 CPU 密集型方案；就有更多 CPU 处理能力可专用于一些诸如服务质量 (QoS) 及加密等三层业务；
- 可扩展性 -- 在 dCEF 模式激活时，CEF 在诸如 Catalyst 6500 系列交换机等高端平台上的每个线路卡处，均提供了完整的交换容量；
- 韧性, resilience -- CEF 提供了大型动态网络中，前所未有的交换一致性和稳定性水平。在动态网络中，快速交换的缓存条目，会频繁地因路由变化而失效。这些变化会导致流量被用到路由表的进程交换，而不是使用路由缓存的快速交换。


## 配置 CEF

启用 CEF 需要使用一条命令，即 `ip cef [distributed]` 这条全局配置命令。其中 `[distributed]` 关键字仅适用于一些比如 Catalyst 6500 系列交换机的，支持 dCEF 的高端交换机。以下输出显示了如何在比如 Catalyst 3750 系列交换机等一些低端平台上，配置 CEF：

```console
VTP-Server-1(config)# ip cef
VTP-Server-1(config)# exit
```


以下输出演示了如何在 Catalyst 6500 系列交换机上，启用 dCEF：

```console
VTP-Server-1(config)# ip cef distributed
VTP-Server-1(config)# exit
```


**注意：** 并无配置或开启 aCEF 的某种显式命令。



> *知识点*：
>
> - Topology-Based Switching
>
> - Cisco Express Forwarding, CEF
>
> - matching a packet' intended destination address, with the IP routing table requires router CPU cycles
>
> + In an attempt to make this process as efficient as possible, Cisco created various switching methods:
>   - process switching, uses the route lookup and best match method
>   - fast switching, a list of IP addresses of recently forwarded packets, is generated by the router as well as the Data Link Layer headers thate were copied if the IP address matched
>   - CEF, as an improvement on fast switching, runs on current models of Cisco routers by default
>
> + CEF
>   - operates at the data plane
>   - is a topology-driven proprietary switch mechanism
>   - creates a forwarding table that is tied to the routing table, which is the control panel
>   - was developed to eliminate the performance penalty experienced due to the first-packet process-switched lookup method used by the flow-based switching
>   - eliminated this by allowing the route cache used by the hardware-based Layer 3 routing engine to contain all the necessary information to the Layer 3 switch in the hareware before any packets associated with a flow are even received
>
> + Information that is conventionally stored in a route cache, is stored in two data stucture for CEF switching, which provide optmised lookup for efficient packet forwarding, are referred to
>   - the FIB
>   - the adjacency table
>
> - when there are routing table changes, the CEF forwarding table is also updated. While new CEF entries are being created, packets are switched in a slower switching path, using process switching
>
> + Forwarding Information Base, FIB
>   - used to make IP destination prefix-based switching decisions
>   - similar to a routing table or information base
>   - maintains a mirror image of the forwarding information contained in the IP routing table
>   - contains all IP prefixes from the routing table
>   - when routing or topology changes occur, are also reflected in the FIB
>   - maintains next-hop address information based on the information in the IP routing table
>   - there is a one-to-one correlation between FIB entries and routing table entries
>   - contains all known routes and eliminates the need for route cache maintenance, which is associated with switching paths, such as fast switching and optmised switching
>   - allows CEF to switch traffic more efficiently than typical demand-caching shemes
>
> + The adjacency table
>   - was created to contain all connected next hops
>   - is populated as adjacencies are discovered
>   - a Data Link Layer header, which will be used to reach a neighbour, called a MAC string or a MAC rewrite, is created and sotred in the adjacency table
>   - a route will point to an adjacent next hop, as soon as it's resolved
>   - if multiple paths exist for the same destination, a point to each adjacency is added to the load-sharing structure, allows for load balancing
>   - prefixes that require exception handling, are cached with special adjacencies
>
> - by default, switches use a central Layer 3 switching engine, with a single processor makes all Layer 3 switching decisions
>
> - having a single Layer 3 switching do all the Layer 3 switching, does not provide sufficient performance
>
> + accelerated CEF, aCEF, with the use of specialised forwarding hareware
>   - allows a portion of the FIB, to be distributed to capable line card modules
>   - allows the forwarding decisions to be made on the local line card, using the locally stored scaled-down CEF table
>   - if FIB entries are not found in the local cache, requests for more FIB information, are sent to the Layer 3 enging
>
> + distributed CEF, dCEF, use of multiple CEF tables distributed across multiple line cards
>   - the Layer 3 engine, i.e., Multilayer Switch Feature Card, maintains the routing table and generates the FIB
>   - the FIB then downloaded in full to each of the line cards
>   - multiple Layer 3 data plane operations are performed simultaneously
>
> - Both dCEF and aCEF, implement multiple Layer 3 switching engines, allows simultaneous Layer 3 switching operations can occur in parallel, boosting system performance
>
> + CEF offers
>   - improved performance
>   - scalability
>   - resilience

