# 简单网络管理协议

SNMP 属于一种应用层（七层）协议，通过使用 UDP 端口 161 及 162，促进网络设备间管理信息的交换。SNMP 管理的网络，由管理系统、代理程序及受管理设备构成。管理系统会执行一些监控应用，并控制那些受管理设备。其还会执行大部分管理进程，并提供用于网络管理的大量存储资源。某个网络可能会由一个或多个管理系统管理。

SNMP 代理位于各个受管理设备上，并将诸如于软件陷阱中捕获到的性能数据或事件，以及错误信息等本地管理信息数据，转换为某种管理系统可读的格式。SNMP 代理会会使用传输数据至网络管理软件的一些获取-请求（译注：[SNMP `get-requests` 指令](../pdfs/06-ch06.pdf)）。SNMP 代理会捕获来自管理信息库的数据，而所谓管理信息库，是一些设备参数于网络数据存储库，或来自报错抑或变更陷阱。

诸如路由器、交换机、计算机或防火墙等受管理元素，会经由 SNMP 代理加以访问。受管理设备会收集并存储管理信息，并通过 SNMP 协议使管理信息对别的，有着同样协议兼容性的管理系统可用。下图 34.1 演示了 SNMP 管理网络中，这三个主要核心组件的交互。


![SNMP 的网络组件交互](../images/4002.png)


**图 34.1** -— **SNMP 的网络组件交互**


参照图 34.1，其中 `R1` 便是 SNMP 管理的设备。逻辑上驻留于该设备上的，就是 SNMP 代理。SNMP 代理会将存储在受管理设备管理数据库中的本地管理信息数据，转换为管理系统的某种可读形式，而管理系统也被称为网络管理站（NMS）。

使用 SNMP 时，受管理设备是通过三个常用 SNMP 命令，得以监控与控制的：`read`、`write` 及 `trap`。`read` 命令由 NMS 用于监控受管理设备。这是通过 NMS 检查那些由受管理设备维护的不同变量完成的。`write` 命令由 NMS 用于控制受管理设备。通过使用这条命令，NMS 便可修改那些存储在受管理设备中变量的值。最后，SNMP 的 `trap` 命令，被受管理设备用于报告事件到 NMS。设备可被配置为发送 SNMP 的陷阱或通知到 NMS。所发送的陷阱和通知，取决于运行在设备上的 Cisco IOS 软件版本及平台。

所谓 SNMP 陷阱，只是一些就网络上的某种情形，向 SNMP 管理器发出告警的消息。某个 SNMP 陷阱示例，便可能包含某个接口从 `up` 状态到 `down` 状态的过渡。SNMP 陷阱的主要问题，他们属于无确认的。这意味着发送设备不具备确定出，这次陷阱是否已被 NMS 接收的能力。

而所谓 SNMP 通知，属于包含来自 SNMP 管理器的接收确认的 SNMP 陷阱。这些消息可用于表明比如失败的认证尝试，或到邻居路由器连接丢失等。当管理器未收到某条通知请求时，那么其不会不会发送一个响应。当发送方从未收到一个响应时，那么这一通知请求即可被再次发送。因此，SNMP 的通知，更可能到达其预期目的地。

虽然通知相比陷阱更为可靠，但其缺点是他们会同时消耗路由器及网络上的更多资源。与发送后就立即被丢弃的陷阱不同，SNMP 的通知请求，必须保留于内存中，直至一个响应收到或该请求超时。此外，陷阱会仅发送一次，而当一个响应未从 SNMP 服务器（NMS）接收到时，通知就会被重发数次。

下图 34.2 演示了 SNMP 管理器与 SNMP 代理之间，发送陷阱及通知的通信。

![NMS 与 SNMP 管理元素用到的 UDP 端口](../images/4003.png)

**图 34.2** -— **NMS 与 SNMP 管理元素用到的 UDP 端口**

SNMP 的三个版本分别为：版本 1、2 及 3。版本 1，或 SNMPv1，是 SNMP 协议的初始实现。SNMPv1 运行与诸如用户数据报协议（UDP）、互联网协议（IP），及 OSI 的无连接网络服务（CLNS）等协议之上。SNMPv1 被广泛应用，是 Internet 社区中事实上的网络管理协议。

SNMPv2 修订了 SNMPv1，而包含了在性能、安全性、保密性及管理器间通信方面的一些改进。SNMPv2 还定义了两种新的操作：`GetBulk` 与 `Inform`。`GetBulk` 操作用于高效地获取大块数据。`Inform` 操作允许一个 NMS 发送陷阱信息到另一个 NMS 并于随后接收一个响应。在 SNMPv2 中，若响应 `GetBulk` 操作的某个代理，无法提供某个列表中的全部变量的值，那么他就会提供部分结果。

SNMPv3 提供了先前 SNMP 版本未提供的三项安全服务：消息完整性、认证及加密。SNMPv3 运用消息完整性这项安全服务，确保数据包传输中未遭篡改；SNMPv3 还利用了用于确定消息是否来自某个可靠来源的认证服务；最后，SNMPv3 提供了用于扰乱数据包内容，防止器被未经授权来源窥探的加密服务。

在思科 10S 软件中，`snmp-server host [hostname | address]` 这条命令，用于指定本地设备将向其发送陷阱或通知的 NMS 主机名或IP地址。要允许 NMS 轮询本地设备，SNMPv1 及 SNMPv2c 就需要一个，通过使用 `snmp-server community <name> [ro | rw]` 这条全局配置命令，指定的要么只读访问，要么读写访问的社区字符串。


SNMPv3 未使用这同一种基于社区的安全机制，转而使用了用户与组的安全机制。以下配置示例，演示了如何以两个社区字符串配置这个本地设备：一个用于只读访问，另一个用于读写访问。此外，这个本地设备还被配置为通过使用只读社区字符串，发送 Cisco IOS IP SLA 运行的 SNMP 陷阱，与 `syslong` 到 `1.1.1.1`。

```console
R2#config t
Enter configuration commands, one per line.
End with CNTL/Z.
R2(config)#snmp-server community unsafe RO
R2(config)#snmp-server community safe RW
R2(config)#snmp-server host 1.1.1.1 traps readonlypassword rtr syslog
```

下图 34.3 演示了基于使用 ManageEngine OpManager 这个网络监控软件的 SNMP 轮询，的一份设备资源利用率和可用性的示例报告：


![有关设备资源使用情况的示例 SNMP 报告](../images/4004.png)

**图 34.3** -— **有关设备资源利用率的示例 SNMP 报告**


