# VLAN 间路由的故障排除


VLAN 间路由问题，会以多种形式出现，尤其是考虑到该过程中涉及多个设备（交换机、路由器等）。通过遵循正确的故障排除方法，咱们就应能将问题隔离到某个特定设备，然后将其映射到某项错误配置的特定功能。

从连通性角度来看，需要检查的一些事项包括：

- 检查终端设备是否连接到正确的交换机端口
- 检查交换机端口到正确的路由器端口（在一台路由器用于 VLAN 间路由时）
+ 检查这个过程中涉及到的端口，是否承载着正确的 VLAN
    - 那些连接终端设备的端口，通常属于一些分配给特定 VLAN 的接入端口
    - 连接交换机到路由器的那些端口，通常属于中继端口


在确认设备之间的连通性正确无误后，下一合乎逻辑的步骤，便是排查二层的配置，以中继端口上所配置的封装方式开始，其通常是 802.1Q。接下来，要确保中继链路的两端，配置了同一封装方式。

可用于检查封装类型的一些命令如下：

- `show interface trunk`
- `show interface <number> switchport`

下面是个输出示例。

```console
Cat-3550-1#show interfaces trunk

Port        Mode        Encapsulation       Status      Native vlan
Fa0/1       on          802.1q              trunking    1
Fa0/2       on          802.1q              trunking    1

Port        Vlans allowed on trunk

Fa0/1       1,10,20,30,40,50
Fa0/2       1-99,201-4094
```

由 `show interface trunk` 命令提供的另一重要细节，是中继的状态。这点确认中继是否形成，以及是否需要链路两端加以检查。当接口未处于 `trunking` 模式下时，那么必须要检查的最重要事项之一，就是运行模式（`on`、`auto` 等），以确定其是否被允许，与链路另一端形成中继状态。


中继端口上另外一个需要检查的重要元素便是原生 VLAN。原生 VLAN 错误配置可能带来功能缺失，抑或安全问题。中继链路的两端的原生 VLAN 需要匹配。

假如在完成二层检查任务后，VLAN 间路由问题仍然存在，你就可以继续进行三层配置检查了。依据用于实现 VLAN 间路由的三层设备，可能会在下列设备上进行配置及配置检查。

- 多层交换机，multilayer switch
- 路由器 -- 物理接口， router -- physical interfaces
- 路由器 -- 子接口，router -- subinterfaces


三层设备上应该检查一下其各接口（或者交换机虚拟接口，SVI）都有分配的正确的子网，同时如有必要，你还应检查一下路由协议。通常情况下，各个 VLAN 都有分配不同的子网，所以你应确保你未曾错误配置了接口。而为检查此项，你可以对特定物理接口、子接口或是 SVI，使用 `show interface` 命令。


