# 不同的 IPv6 地址类型

IPv4 支持四种不同类别的地址，即任意播、广播、组播及单播。尽管在这本指南前面的模组中，任意播这个术语不曾用到，但重要的是记住，任意播的地址，并不属于特殊类型的地址。相反，任播地址只是分配给多个接口的某个 IP 地址。用到任意播寻址的一些常见技术的示例，包括一些 IP 多播实现，以及 6to4 的中继实现等。

> *知识点*：
>
> - Anycast
>
> - Broadcast
>
> - Multicast
>
> - Unicast

**注意**：所谓 6to4，是种从 IPv4 迁移到 IPv6 的过渡机制。对于 CCNA 考试，你只需知道其存在即可。

在任意播寻址下，设备会使用根据路由协议度量值，（确定出的）离他们最近的共用地址。在主地址不再可达事件下，那么下一个最近地址就会被使用。下图 3.5 演示了这一概念。


![理解任意播寻址方式](../images/0705.png)

**图 3.5** -- **了解任播地址**

参照图 3.5，R1 和 R2 均有个使用共用地址：`15.1.1.254/32` 配置的 `Loopback 254` 接口。这个前缀随后会经由 EIGRP 动态通告。默认情况下，R1 和 R2 都经通过其各自的 `Loopback` 接口，首选 `15.1.1.254/32` 这个前缀，因为这是个直接连接的子网。因此，两个路由器上用到的这个共用地址，将永远不会冲突。

假设在正常 EIGRP 度量值计算下，R3 和 RS 将首选由 R1 通告的 Anycast 地址，由于较低的 IGP 度量值（我们稍后会介绍度量值）。与此类似，由于较低的 IGP 度量值，R4 和 R6 优选 R2 公布的 Anycast 地址。在 R1 或 R2 失效的事件下，网络中的其余路由器，将使用由剩下的那台路由器通告的 Anycast 地址。在使用 Anycast 寻址时，组织可既使用 [RFC 1918](https://datatracker.ietf.org/doc/html/rfc1918) 地址空间中的单播地址，也可其公开区块内的单播地址。


**注意**：在当前的 CCNA 考试中，咱们不需要实施任何 Anycast 寻址或解决方案。不过重要的是要熟悉这一概念。在咱们学习了路由的一些章节后，熟悉这一概念将更有意义。

在这个层面上，IPv4 的广播、组播和单播地址，不需要进一步解释，这个教学模组或本指南的其余部分，也将不再详细介绍。在 IPv4 支持这四种不同类型地址的同时，IPv6 则取消了广播地址，而只支持以下的地址类型：


- 链路本地地址
- 站点本地地址
- 聚合全局单播地址
- 多播地址（译注：已废除，取而代之的是本地唯一地址，Unique-Local addresses, ULAs）
- 任意播地址
- 环回地址
- 未指定地址

## 链路本地地址

IPv6 链路本地地址，只能在本地链路（即设备间的共用网段）上使用，并在接口上启用 IPv6 时，被自动分配给该接口。这些地址是从链路本地的前缀 `FE80::/10` 分配的。请记住，`FE80::/10` 相当于 `FE80:0:0:0:0:0:0:0:0:0:0:0/10`，其也可以表示为 `FE80:0000:0000:0000:0000:0000:0000/10`。要补全地址，第 11 位至第 64 位会被设置为 `0`，同时接口的扩展唯一标识符 64 (EUI-64) ，会被作为低序的 64 位，附加到链路本地地址。EUI-64 由 IEEE 分配的 24 位制造商 ID，与由该制造商分配给其产品的 40 位值组成。EUI-64 分址，会在这个教学模组稍后详细介绍。链路本地地址的格式，在下图 3.6 中演示了出来。

![IPv6本地链路分址](../images/0706.png)

**图 3.6** -- **IPv6 链路本地地址**

链路本地地址的唯一性在于，一旦其被分配给某个接口，那么他们就不会改变。这意味着，当某个接口被分配了一个公开 IPv6 地址（如 `2001:1000::1/64`），且这个公开 IPv6 前缀发生了变化（如 `2001:2000::1/64`）时，链路本地地址也不会改变。这就允许当 IPv6 的全局互联网地址变化时，主机或路由器通过其邻居仍保持可达。IPv6 的路由器不应转发那些带有链接本地源地址或目标地址的数据包。

## 站点本地地址


所谓站点本地地址，属于一些仅在站点内使用的单播地址。与链路本地地址不同，站点本地地址必须在网络设备上手动配置。这些地址是定义在 [RFC 1918](https://datatracker.ietf.org/doc/html/rfc1918) 中私有 IPv4 地址空间的 IPv6 等价物，而可被一些没有全球可路由 IPv6 地址空间的组织使用。这些地址在 IPv6 互联网上不可路由。

虽然对 IPv6 执行 NAT 是可行的，但其不被建议；这也是 IPv6 地址大得多的原因。站点本地地址由 `FECO::/10` 前缀、54 位的子网 ID，以及由链路本地地址使用的 EUI-64 格式接口标识符组成。当链路本地地址中的 54 位被设置为值 `0` 时，站点本地地址中的同样 54 位会被用于创建不同的 IPv6 前缀（最多 `254` 个）。站点本地地址的格式如下图 3.7 中所示。


![IPv6站点本地分址](../images/0707.png)

**图 3.7** -- **IPv6 站点本地地址**

虽然 IPv6 站点本地地址在这一小节中介绍了，并在 Cisco IOS 软件下仍然支持，但重要的是知道这些地址已由 [RFC 3879](https://datatracker.ietf.org/doc/html/rfc3879)（弃用站点本地地址）弃用。此外，[RFC 4193](https://datatracker.ietf.org/doc/html/rfc4193)（唯一本地 IPv6 单播地址），介绍了提供站点本地地址的功能，却在 IPv6 全球互联网上无法路由，只能在站点内部路由的唯一本地地址。

唯一本地地址是分配自 `FC00::/7` 的IPv6 地址块，其随后会进一步分为两个叫做分配组和随机组的 `/8` 地址组。这两个组便是 `FC00::/8` 和 `FD00::/8` 的 IPv6 地址块。`FC00::/8` 这个组由在用的 `/48` 分配局管理，而 `FDO00::/8` 这个组，则是通过添加一个随机生成的 40 位字符串，派生处一个有效的 `/48` 组形成。


## 聚合全球单播地址


聚合全球单播地址，是一些用于通用 IPv6 流量，以及 IPv6 互联网的 IPv6 地址。这些地址类似于 IPv4 下用到公开地址。从网络寻址视角，每个 IPv6 全球单播地址，都是由三个主要部分组成：从运营商处收到的前缀（48 位长）、站点前缀（16 位长）与主机部分（64 位长）。这构成了 IPv6 下用到的 128 位地址。

正如我们在这个教学模组前面了解到的，运营商分配的前缀，由某家 IPv6 运营商分配给某个组织。默认情况下，这些前缀会使用 `/48` 的前缀长度。此外，这些前缀分配自由运营商持有的 IPv6 地址空间（即那个 `/32` 前缀长度）。每家运营商都将拥有其自己的 IPv6 地址空间，同时由一家运营商分配的 IPv6 前缀，无法用在另一家运营商的网络上。

在某个站点内部，管理员此时便可运用供子网划分的 49 到 64 位，将这个运营商提供的 48 位前缀，划分为 64 位的站点前缀，这样就允许可供其网络内使用的 65,535 个不同子网。IPv6 地址的主机部分，表示 IPv6 子网上的网络设备或主机。这是由 IPv6 地址的低序 64 位表示。

IPv6 的聚合全局单播地址，是由互联网编号分配局（IANA）分配，并位于 IPv6 的前缀 `2000::/3` 中。这允许了一个从 `2000` 到 `3FFF` 的聚合全局单播地址范围，如下表 3.4 所示。

**表 3.4** -- **IPv6 聚合全局单播地址**

| 说明 | 地址 | 压缩形式 |
| -- | -- |
| 范围中的第一个地址 | `2000:0000:0000:0000:0000:0000:0000:0000` | `2000::` |
| 范围中的最后一个地址 | `3FFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF` | 同前 |
| 二进制标记 | 高序的三位被设置为`001` | -- |

在这个教学模组编写时，`2000::/3` 这个 IPv6 地址块中，只有三个子网已被分配使用。这些分配情况如下表 3.5 中所示。

**表 3.5** -- **已分配的 IPv6 聚合全局单播地址**


| IPv6 全球前缀 | 二进制表示 | 说明 |
| -- | -- | -- |
| `2001::/16` | `0010 0000 0000 0001` | 全球性 IPv6 互联网(单播) |
| `2002::/16` | `0010 0000 0000 0000` | `6to4` 迁移的前缀 |
| `3FFE::/16` | `0010 1111 1111 1110` | `6bone` 的前缀 |

**注意**： `6to4` 过渡地址和 `6bone` 前缀在这本指南中均未有任何详细介绍。

在 IPv6 全局聚合单播地址范围内，一个称为 ORCHID（定义在 [RFC 4843](https://datatracker.ietf.org/doc/html/rfc4843) 中 Overlay Routable Cryptographic Hash Identifiers 的缩写）的特殊实验范围被保留了。ORCHID 地址属于一些用于加密散列标识符的不可路由 IPv6 地址。这些地址使用了 IPv6 前缀 `2001:10::/28`。详细介绍 ORCHID 地址，超出了当前 CCNA 考试要求范围，因将不包括于这个教学模组，或本指南的其余部分。

## 组播地址

IPv6 中用到的组播地址，派生自 `FF00::/8` 这个 IPv6 前缀。在 IPv6 下，组播会以不同于 IPv4 中的方式运行。IP 组播在 IPv6 下被广泛使用，并取代了一些 IPv4 的协议，比如地址解析协议（ARP）等。此外，组播在 IPv6 下用于前缀通告与重编号，以及重复地址检测（DAD）等。这些概念会在这个教学模组稍后介绍。


IPv6 下的组播数据包，没有使用 TTL 值将这些数据包限制在本地网段。范围限制是经由组播地址内的 `Scope` 字段，定义在组播地址本身中。某个网段上的 IPv6 节点会监听组播，甚至发送组播数据包交换信息。这允许某个 IPv6 网段上的全部节点，都清楚同一网段上的全部其他邻居。IPv6 网络中用到的组播地址格式，如下图 3.8 中所示。


![IPv6多播分址](../images/0708.png)


**图 3.8** -- **IPv6 多播地址**

如图 3.8 中所示，IPv6 的组播地址格式，与到目前为止咱们所了解的其他 IPv6 地址格式略有不同。IPv6 组播地址的前 8 位，表示组播前缀 `FF::/8`。IPv6 组播地址中的 `Flag` 字段，用于表明多播地址的类型，要么是永久组播地址，或者是临时组播地址。


永久的 IPv6 组播地址由 IANA 分配，而临时 IPv6 组播地址，则可用于部署前的组播测试。`Flag` 字段可包含下表 3.6 中所示的两种可能值之一。

**表 3.6** -- **IPv6 永久和临时组播地址**

| 组播地址类型 | 二进制表示 | 十六进制值 |
| -- | -- | -- |
| 永久 | `0000` | `0` |
| 临时 | `0001` | `1` |

组播地址中接下来的 4 位表示范围。在 IPv6 组播中，这个字段是个限制组播数据包发往网络中其他区域的强制字段。这个字段本质上提供了与 IPv4 下用到的 TTL 字段相同功能。不过，在 IPv6 下，有数种的范围类型，如下表 3.7 中所示。

**表 3.7** -- **IPv6 组播地址的范围**

| 范围类型 | 二进制表示 | 十六进制值 |
| -- | -- | -- |
| 接口本地 | `0001` | `1` |
| 链路本地 | `0010` | `2` |
| 子网本地 | `0011` | `3` |
| 本地管理域，Admin-Local | `0100` | `4` |
| 站点本地 | `0101` | `5` |
| 组织范围, Organization | `1000` | `8` |
| 全球范围 | `1110` | `E` |

在 IPv6 组播前缀内，某些地址被保留了。这些保留的地址，称为组播分配地址，如下表 3.8 中所示。

**表 3.8** -- **IPv6 保留的组播地址**

| 地址 | 范围 | 说明 |
| -- | -- | -- |
| `FF01::1` | 主机 | 接口本地范围中的全部主机 |
| `FF01::2` | 主机 | 接口本地范围内的全部路由器 |
| `FF02::1` | 链路本地 | 链路本地范围内的全部主机 |
| `FF02::2` | 链路本地 | 链路本地范围内的全部路由器 |
| `FF05::2` | 站点 | 站点本地范围内的全部路由器 |

除这些地址外，对路由器接口，或网络主机上配置的每个单播和任播地址，一个 “节点询问组播地址” 都会被自动启用。这个地址具有链路本地范围，这意味着他将绝不会穿越本地网段之外。“节点询问组播地址” 因以下两个原因而被用到：取代 IPv4 的 ARP，及重复地址检测。

> *知识点*：
>
> - a Solicited-Node Multicast addresse

由于 IPv6 不使用 ARP，因此节点询问组播地址，便被网络主机及路由器，用于学习邻近设备的数据链路地址。这就允许 IPv6 数据包转换为帧并发送到 IPv6 的主机和路由器。DAD 是 IPv6 的邻居发现协议的一部分，其将在本教学模组的稍后详细介绍。DAD 只是允许设备在使用自动配置将某个地址配置为自己的地址前，验证该 IPv6 地址是否已在本地网段使用。从本质上讲，DAD 提供了与 IPv4 下用到 Gratuitous ARP 类似的功能。询问节点组播地址由 IPv6 前缀 `FF02::1:FF00:0000/104` 定义。这些地址由 `FF02::1:FF00:0000/104` 前缀与低位序 24 位的单播或任播地址组成。下图 3.9 展示了这些 IPv6 地址的格式。


> *知识点*：
>
> - the IPv6 Neighbor Discovery Protocol
>
> - Duplicate Address Detection



![IPv6节点询问多播地址](../images/0709.png)

**图 3.9** -- **IPv6 节点询问组播地址**

与 IPv4 的以太网组播映射类似方式，IPv6 也用到一种独特方式，将三层的 IPv6 组播地址，映射到二组播地址。IPv6 下的组播映射，是经由将组播地址的低位序 32 位，附加到 16 位的前缀 `33:33` 来实现的，这个 16 位的 `33:33` 前缀，便是为 IPv6 网络定义的组播以太网前缀。这在有关接口本地范围前缀 `FF02::2` 上所有路由器的下图 3.10 中被展示。

![IPv6多播地址](../images/0710.png)

**图 3.10** -- **IPv6 的多播地址**

## 任播地址

这一小节前面引入的 Anycast，可简单地描述为一对最近的通信，因为根据路由协议度量值，最近的共用地址，将总是会被本地设备优先选用。在 IPv6 下，没有为 Anycast 专门分配的范围，因为 Anycast 地址会使用全局单播、站点本地甚至链路本地地址。不过，有个 Anycast 地址被保留作专门用途。这种特殊地址被称为子网-路由器 Anycast 地址，由子网的 64 位单播前缀，与其余 64 位置为零构成（例如，`2001:1a2b:1111:d7e5:0:0:0:0`）。任播地址不得用作 IPv6 数据包的源地址。这些地址通常会被诸如移动 IPv6 等协议用到，而这已超出 CCNA 的范围。


## 环回地址

IPv6 下的环回地址，会以与 IPv4 相同方式用到。每个设备都有个 IPv6 回环地址，相当于 IPv4 下用到的 `127.0.0.1` 回环地址，该地址由设备本身使用。IPv6 的环回地址使用前缀 `::1`，在首选地址格式下可表示为 `0000:0000:0000:0000:0000:0000:0000:0000:0001`。这意味着，在环回地址中，除总是设置为 `1` 的最后一位外，所有的位都设置为 `0`。当设备上启用 IPv6 时，这些地址总是自动分配，且他们永不能更改。

## 未指明地址

在 IPv6 分址下，未指明地址只是一些未分配给任何接口的单播地址。这些地址表明 IPv6 地址缺失，并用于一些特殊目的，包括 IPv6 的 DHCP 和 DAD。未指明地址由 IPv6 地址中的全 `0` 值表示，可使用 `::` 前缀书写。在首选格式下，这些地址表示为 `0000:0000:0000:0000:0000:0000:0000:0000:0000:0000:0000`。


