# 不同的 IPv6 地址类型

IPv4 支持四种不同类别的地址，即任意播、广播、组播及单播。尽管在这本指南前面的模组中，任意播这个术语不曾用到，但重要的是记住，任意播的地址，并不属于特殊类型的地址。相反，任播地址只是分配给多个接口的某个 IP 地址。用到任意播寻址的一些常见技术的示例，包括一些 IP 组播实现，以及 6to4 的中继实现等。

> *知识点*：
>
> - Anycast
>
> - Broadcast
>
> - Multicast
>
> - Unicast

**注意**：所谓 6to4，是种从 IPv4 迁移到 IPv6 的过渡机制。对于 CCNA 考试，咱们只需知道其存在即可。

在任意播寻址下，设备会使用根据路由协议的度量值，使用离他们最近的共用地址。下一最近地址随后会在主地址不再可达的情形下被用到。这一概念在下图 3.5 中得以演示。


![理解任意播寻址方式](../images/0705.png)

**图 3.5** -- **理解任播寻址**

参照图 3.5，`R1` 和 `R2` 均配置了使用共用地址 `15.1.1.254/32` 的 `Loopback 254` 接口。这个前缀随后会经由 EIGRP 动态通告。默认情况下，`R1` 和 `R2` 都将优先选择各自环回接口上的这个 `15.1.1.254/32` 前缀，因他们均为一个直连子网。因此，这个用到的通用地址将永远不会在两台路由器上造成冲突。

假设在正常 EIGRP 度量值计算下，由于较低的 IGP 度量值（我们稍后会介绍度量值），`R3` 和 `R5` 将首选由 `R1` 通告的任播地址。同样，由于较低的 IGP 度量值，`R4` 和 `R6` 将优选由 `R2` 通告的任播地址。在 `R1` 或 `R2` 失效的情形下，该网络中的其余路由器，将使用由剩下那台路由器通告的任播地址。在使用任播的寻址时，组织可既使用 [RFC 1918](https://datatracker.ietf.org/doc/html/rfc1918) 地址空间中的单播地址，也可其公开区块内的单播地址。


**注意**：在当前的 CCNA 考试中，咱们不需要部署任何任意播的寻址或解决方案。但是，重要的是要熟悉这一概念。在咱们学习了路由章节后，其就将更有意义。

在 CCNA 层级上，IPv4 的广播、组播和单播地址无需进一步解释，且在这一教学模组或这本指南的其余部分中都将不再详细介绍。虽然 IPv4 支持这四种不同地址类型，但 IPv6 取消了广播地址，而只支持以下的地址类型：


- 链路本地地址
- 站点本地地址
- 聚合全球单播地址
- 组播地址（译注：已废除，取而代之的是本地唯一地址，Unique-Local addresses, ULAs）
- 任意播地址
- 环回地址
- 未指定地址（即 `::/0`）

## 链路本地地址

IPv6 的链路本地地址，只能用在本地链路（即设备间的共享网段）上，并在 IPv6 于接口上时被自动指派给接口。这些地址是非配自链路本地前缀 `FE80::/10` 的。要记住，`FE80::/10` 相当于 `FE80:0:0:0:0:0:0:0:0:0:0:0/10`，也可表示为 `FE80:0000:0000:0000:0000:0000:0000/10`。要补全这一地址，11 至 64 位就会被设置为 `0`，而接口的扩展唯一标识符 64 (EUI-64) ，会被作为低序的 64 位，追加到链路本地地址。所谓 EUI-64，是由 IEEE 分配的 24 位制造商 ID，与由该制造商分配给其产品的 40 位值组成。EUI-64 的分址，会在这一教学模组 [稍后](./IPv6_protocols_and_mechanisms.md#eui-64) 更详细地介绍。链路本地地址的格式，在下图 3.6 中得以演示。

![IPv6本地链路分址](../images/0706.png)

**图 3.6** -- **IPv6 的链路本地分址**

链路本地地址的唯一性在于，一旦他们被指派给某个接口，他们就不会改变。这意味着，当某个接口被指派了个公共 IPv6 地址（如 `2001:1000::1/64`），且这个公共 IPv6 前缀被改变（如 `2001:2000::1/64`）时，链路本地地址不会改变。这实现了在 IPv6 的全球 Internet 地址改变时，主机或路由器保持对其邻居仍可达。IPv6 的路由器不应转发那些有着链路本地的源地址或目的地址的数据包。

## 站点本地地址


所谓站点本地地址，属于一些仅用于某一站点内部的单播地址。不同于链路本地地址，站点本地地址必须手动配置于网络设备上。这些地址属于定义在 [RFC 1918](https://datatracker.ietf.org/doc/html/rfc1918) 中 IPv4 私有地址空间的 IPv6 等价物，而可被一些没有全球可路由 IPv6 地址空间的组织使用。这些地址在 IPv6 的 Internet 上不可路由。

虽然对 IPv6 执行 NAT 是可行的，但其不被建议；这正是 IPv6 地址大得多的原因。站点本地地址由 `FECO::/10` 前缀、54 位的子网 ID，及由链路本地地址用到的 EUI-64 格式接口标识符组成。尽管链路本地地址中的那 54 位都被设置为 `0` 的值，站点本地地址中的同样 54 位，会被用于创建不同的 IPv6 前缀（最多 254 个）。站点本地地址的格式如下图 3.7 中所示。


![IPv6站点本地分址](../images/0707.png)

**图 3.7** -- **IPv6 的站点本地分址**

虽然 IPv6 的站点本地地址在这一小节中介绍了，并在 Cisco IOS 软件中仍受支持，但重要的是要知道，这些地址已被 [RFC 3879](https://datatracker.ietf.org/doc/html/rfc3879)（弃用站点本地地址）弃用。此外，[RFC 4193](https://datatracker.ietf.org/doc/html/rfc4193)（唯一本地的 IPv6 单播地址），介绍了提供与站点本地地址同一功能，却在 IPv6 全球 Internet 上不可路由，而只能在某一站点内部路由的唯一本地地址。

所谓唯一本地地址，是分配自 `FC00::/7` 这个 IPv6 地址块，其随后被进一步分为两个 `/8` 的地址组，非别称为分配组与随机组。这两个组分别是 `FC00::/8` 与 `FD00::/8` 两个 IPv6 地址块。`FC00::/8` 这个组由在用的 `/48` 地址块分配局管理，而 `FDO00::/8` 这个地址块，则是通过追加一个随机生成的 40 位字符串形成，以派生出一个有效的 `/48` 地址块。


## 聚合全球单播地址

所谓聚合全球单播地址，属于用于通用 IPv6 流量以及 IPv6 Internet 的 IPv6 地址。这些地址类似于 IPv4 下用到公网地址。从网络寻址角度看，每个 IPv6 全球单播地址，都是由三个主要部分构成：

- 接收自服务提供商的前缀（长度为 48 位）
- 站点前缀（长度为 16 位）
- 与主机部分（长度为 64 位）

这就构成了 IPv6 下用到的 128 位地址。

正如我们在这一教学模组早先了解到的，服务提供商分配的前缀，是由某家 IPv6 服务提供商分配给某一组织的。默认情况下，这些前缀使用 `/48` 的前缀长度。此外，这些前缀是从该服务提供商运所持有的 IPv6 地址空间（即 `/32` 的前缀长度）分配的。每家服务提供商都将拥有其自己的 IPv6 地址空间，并且由一家服务提供商分配的 IPv6 前缀，不能在另一家的网络上使用。

在某一站点内部，管理员随后便可通过将 49 到 64 位用于子网划分，把这个服务提供商分配的 48 位前缀，划分为一些 64 位的站点前缀，从而允许在其网络中 65,535 个不同子网的用途。IPv6 地址的主机部分，表示 IPv6 子网上的网络设备或主机。这一部分由 IPv6 地址的低序 64 位表示。

IPv6 的聚合全局单播地址由互联网号码分配局（IANA）分配，位于 IPv6 前缀 `2000::/3` 中。这使得聚合全球单播地址的范围从 `2000` 到 `3FFF`，如下表 3.4 中所示。

**表 3.4** -- **IPv6 的聚合全球单播地址**

| 说明 | 地址 | 压缩形式 |
| :-- | --: | --: |
| 范围中的第一个地址 | `2000:0000:0000:0000:0000:0000:0000:0000` | `2000::` |
| 范围中的最后一个地址 | `3FFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF` | `3FFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF` |
| 二进制表示法 | 三个高序的二进位被设置为 `001` | -- |

介质这一教学模组编写时，`2000::/3` 这个 IPv6 地址块中，只有三个子网已被分配使用。这些分配如下表 3.5 中所示。

| IPv6 全球前缀 | 二进制表示 | 说明 |
| --: | --: | :-- |
| `2001::/16` | `0010 0000 0000 0001` | 全球 IPv6 Internet(单播) |
| `2002::/16` | `0010 0000 0000 0000` | `6to4` 过渡的前缀 |
| `3FFE::/16` | `0011 1111 1111 1110` | `6bone` 的前缀 |

**注意**： `6to4` 过渡地址与 `6bone` 前缀在这本指南中均不会有任何详细介绍。

> *译注*：原文这里存在拼写错误，其将 `3FFE::/16` 错误写作了 `0110 1111 1111 1110`。

在 IPv6 的全球聚合单播地址范围内，称为 ORCHID（定义在 [RFC 4843](https://datatracker.ietf.org/doc/html/rfc4843) 中，Overlay Routable Cryptographic Hash Identifiers 的缩写）的一个特殊实验范围得以保留。ORCHID 地址属于一些用于加密哈希标识符的非路由 IPv6 地址。这些地址使用了 IPv6 前缀 `2001:10::/28`。深入探讨 ORCHID 地址的细节，超出当前 CCNA 考试要求范围，而将不会在这一教学模组，或这本指南其余部分包含。

## 组播地址

IPv6 中用到的组播地址源自 `FF00::/8` 这一 IPv6 前缀。在 IPv6 下，组播会以与 IPv4 中组播不同方式运行。IP 组播在 IPv6 下被广泛使用，并取代了比如地址解析协议（ARP）等一些 IPv4 的协议。此外，组播在 IPv6 下还用于前缀的通告及重编号，以及重复地址检测（DAD）等。这些概念都会在这一教学模组稍后介绍。

IPv6 中的组播数据包，未使用 TTL 值将此类数据包限制在本地网段。相反，范围限制是经由组播地址内的 `Scope` 字段，定义在组播地址本身中。网段上的 IPv6 节点会监听组播，甚至发送组播数据包交换信息。这一用途允许某个 IPv6 网段上的全部节点，都了解同一网段上的全部其他邻居。IPv6 网络中用到的组播地址格式，如下图 3.8 中所示。


![IPv6 的组播分址](../images/0708.png)


**图 3.8** -- **IPv6 的组播寻址**

如图 3.8 中所示，IPv6 组播地址的格式，与到目前为止咱们已了解的其他 IPv6 地址格式略有不同。IPv6 的组播地址前 8 位，表示组播前缀 `FF::/8`。IPv6 组播地址中的 `Flag` 字段，用于表明多播地址类型，要么是永久的，要么是临时的。


永久的 IPv6 组播地址由 IANA 分配，而临时 IPv6 组播地址，则可用于部署前的组播测试。`Flag` 字段可包含下表 3.6 中所示的两种可能值之一。

**表 3.6** -- **IPv6 永久和临时组播地址**

| 组播地址类型 | 二进制表示 | 十六进制值 |
| -- | -- | -- |
| 永久 | `0000` | `0` |
| 临时 | `0001` | `1` |

组播地址中接下来的 4 位表示范围。在 IPv6 的组播中，这个字段属于一个强制性自断，限制组播数据包被发送到网络中其他区域。这个字段本质上提供了用于 IPv4 中的 `TTL` 字段同样的功能。但在 IPv6 下，有数种的范围类型，如下表 3.7 中所示。

**表 3.7** -- **IPv6 组播地址的范围**

| 范围类型 | 二进制表示 | 十六进制值 |
| -- | -- | -- |
| 接口本地 | `0001` | `1` |
| 链路本地 | `0010` | `2` |
| 子网本地 | `0011` | `3` |
| 本地管理域，Admin-Local | `0100` | `4` |
| 站点本地 | `0101` | `5` |
| 组织范围, Organization | `1000` | `8` |
| 全球范围 | `1110` | `E` |

在 IPv6 的组播前缀中，某些地址被保留了。这些保留的地址称为组播分配地址，Multicast Assigned addresses，如下表 3.8 中所示。

**表 3.8** -- **IPv6 保留的组播地址**

| 地址 | 范围 | 说明 |
| -- | -- | -- |
| `FF01::1` | 主机 | 接口本地范围中的全部主机 |
| `FF01::2` | 主机 | 接口本地范围内的全部路由器 |
| `FF02::1` | 链路本地 | 链路本地范围内的全部主机 |
| `FF02::2` | 链路本地 | 链路本地范围内的全部路由器 |
| `FF05::2` | 站点 | 站点本地范围内的全部路由器 |

除了这些地址外，针对某一路由器接口或网络主机上配置的每个单播与任意播地址，都会自动启用一个节点询问组播地址，a Solicited-Node Multicast address。这个地址有着链路本地的范围，这意味着他将绝不会穿越本地网段之外。节点询问组播地址因以下两个原因而被用到：取代 IPv4 的 ARP，及重复地址检测。

由于 IPv6 不使用 ARP，因此节点询问组播地址便被网络主机及路由器，用于学习邻近设备的数据链路地址。这一用途就实现了到 IPv6 主机和路由器的数据包，被转换为数据帧并作为数据帧发送。DAD 是 IPv6 邻居发现协议（NDP）的一部分，其将在本教学模组稍后详细介绍。DAD 只是实现了设备在使用自动配置将某个地址配置为自己的地址前，验证其是否已在本地网段使用。从本质上讲，DAD 提供了用于 IPv4 中的无故 ARP 类似的功能。询问节点组播地址由 IPv6 前缀 `FF02::1:FF00:0000/104` 定义。这些地址由 `FF02::1:FF00:0000/104` 前缀，与低位序 24 位的单播或任播地址组成。下图 3.9 展示了这些 IPv6 地址的格式。


> *知识点*：
>
> - the IPv6 Neighbor Discovery Protocol
>
> - Duplicate Address Detection
>
> - Gratuitous ARP used in IPv4



![IPv6 节点询问组播地址](../images/0709.png)

**图 3.9** -- **IPv6 的节点询问组播地址**

以类似于 IPv4 的以太网组播映射方式，IPv6 也使用一种独特方式，将三层的 IPv6 组播地址，映射到二层组播地址。IPv6 下的组播映射，是通过将组播地址的低位序 32 位，追加到 16 位前缀 `33:33` 而启用的，这个 16 位 `33:33` 的前缀，便是为 IPv6 网络定义的组播以太网前缀。这在针对接口本地范围前缀 `FF02::2` 上的所有路由器的下图 3.10 中得以展示。

![IPv6多播地址](../images/0710.png)

**图 3.10** -- **IPv6 的组播地址**

## 任播地址

这一小节前面引入的任意播，可简单地描述为一对最近的通信，因为根据路由协议度量值，最近的共用地址，将总是会被本地设备优先选用。在 IPv6 下，没有为 Anycast 专门分配的范围，因为 Anycast 地址会使用全局单播、站点本地甚至链路本地地址。不过，有个 Anycast 地址被保留作专门用途。这种特殊地址被称为子网-路由器 Anycast 地址，由子网的 64 位单播前缀，与其余 64 位置为零构成（例如，`2001:1a2b:1111:d7e5:0:0:0:0`）。任播地址不得用作 IPv6 数据包的源地址。这些地址通常会被诸如移动 IPv6 等协议用到，而这已超出 CCNA 的范围。


## 环回地址

IPv6 下的环回地址，会以与 IPv4 相同方式用到。每个设备都有个 IPv6 回环地址，相当于 IPv4 下用到的 `127.0.0.1` 回环地址，该地址由设备本身使用。IPv6 的环回地址使用前缀 `::1`，在首选地址格式下可表示为 `0000:0000:0000:0000:0000:0000:0000:0000:0001`。这意味着，在环回地址中，除总是设置为 `1` 的最后一位外，所有的位都设置为 `0`。当设备上启用 IPv6 时，这些地址总是自动分配，且他们永不能更改。

## 未指明地址

在 IPv6 分址下，未指明地址只是一些未分配给任何接口的单播地址。这些地址表明 IPv6 地址缺失，并用于一些特殊目的，包括 IPv6 的 DHCP 和 DAD。未指明地址由 IPv6 地址中的全 `0` 值表示，可使用 `::` 前缀书写。在首选格式下，这些地址表示为 `0000:0000:0000:0000:0000:0000:0000:0000:0000:0000:0000`。


