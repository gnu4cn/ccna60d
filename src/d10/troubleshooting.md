# STP 故障排除

大多数二层问题，都与网域内的某种环路有关，而网络环路又有多种相关问题，包括网络宕机。在咱们进行交换机配置，以及插拔设备时，咱们应确保未在过程中创建环路。为了消除此类问题，咱们通常应在交换机上配置生成树协议，避免咱们在网络中某处，不小心创建出环路时，可能发生的情况。

网络中的每台交换机，都使用 MAC 地址通信。当数据包到来时，MAC 地址即被分析，而交换机会根据二层头部中的目的 MAC 地址，确定数据包的去向。网络中的每台设备都有其自己的 MAC 地址，因此全体数据包的去向，都非常明确。不幸的是，像广播和组播这样的东西，会前往交换机上的每个端口。当一个广播数据帧到达某个交换机端口时，交换机会将该广播拷贝到可能连接到该交换机的每个其他设备。当咱们在网络中有着环路时，这一过程经常会是个问题。

咱们还应该记住，MAC 地址的数据包，在其内部都没有超时机制。在 TCP/IP 协议情形下，IP 协议在其头部有一种称为 TTL（存活时间）的功能，其指的是通过路由器的跳数，而并不真的是某个特定时间单位。因此，当 IP 数据包碰巧处于某个环路中，并经过多个路由器时，他们最终将超时而被从网络上移除。另一方面，交换机并未提供这种机制。理论上，二层的数据帧可永远循环，因为没有将其超时的机制，也就是说，当咱们创建出一个循环时，他就会一直存在，直到咱们手动将其从网络上删除。

当咱们将一台工作站插入网络，且广播到达该工作站时，广播将在处终止，而将不是个网络问题。另一方面，当咱们错误配置了交换机侧上某个端口的配置，或咱们在未启用 STP 下，将网线两端都插入到某台交换机时，这就可能在二层域内，引发广播风暴。这之所以会发生，是因为广播数据包会被转发到所有其他端口，因此广播数据包会在同一条网线上不断进出交换机，从而造成二层环路。这会导致高资源使用量，甚至网络宕机。

当咱们在这种错误配置的网络上启用 STP 时，交换机将识别到某个环路已经发生，同时其会阻塞某些端口避免广播风暴。交换机上的其他端口，会继续正常运行，因此网络不会被影响。当 STP 未被配置时，唯一的选择就是拔掉导致问题的网线，或者在咱们还能操作交换机时，管理性禁用该端口。

STP 的问题通常分为以下三类：

- 不正确的根网桥
- 不正确的根端口
- 不正确的指定端口


## 不正确的根桥

优先级和背板 MAC 地址，决定了根桥是否正确。咱们可执行 `show spanning-tree vlan <vlan#>` 命令，查看这个 MAC 地址及交换机的优先级。咱们可使用 `spanning-tree vlan <vlan#> priority <priority>` 命令，修复这一问题。

## 根端口不正确

根端口提供了自该交换机到根桥的最快路径，而开销是跨越这整个路径的累加值。当咱们某个不正确根端口时，咱们可执行 `show spanning-tree vlan <vlan#>` 命令。当根端口不正确时，咱们可执行 `spanning-tree cost <cost>` 命令修复。

## 指定端口不正确

所谓指定端口，是将某个网段连接到网络其余部分时，有着最低开销的那个端口。当咱们怀疑指定端口的某个问题时，咱们可执行 `show spanning-tree vlan <vlan#>` 和 `spanning-tree cost <cost>` 两个命令。

可以调试相关事件的一个有用 STP 故障排除命令，是 `Switch#debug spanning-tree events`。


