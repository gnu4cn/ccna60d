# 灾难恢复计划与流程

当咱们的数据面临风险时，那么保护其免受外部威胁当然就至关重要。然而威胁不仅会以恶意攻击的形式出现，还可以意外事故以及自然本身的形式出现（即故障与天灾），这正是为何有必要为这些事件准备。这一小节将涵盖以下主题：

- 备份/回退的应急预案或政策
- 备份、执行及频率
- 冗余与容错
- 高可用
- 冷站点、热站点及暖站点
- 平均恢复时间、平均故障间隔时间、恢复时间目标和恢复点目标

## 备份/回退的应急预案或政策

制订数据恢复策略时，要记住的最重要事情，是要确保生产数据备份于某一异地位置。这样做能保了在主站点遭毁坏的最坏情况下，数据将安全存放于某一不同物理场所。灾难恢复的两大主要因素分别为：

- 通过冗余保障数据的可用性
- 于其中要恢复运营的异地站点准备（热站点、温站点或冷站点；这些将于随后讨论）


在每个企业中，以这两项计划为重点并完善他们，以确保公司数据不致丢失都很重要。这些灾难恢复计划（DRP）应包括以下的主要措施类型：

- 有助于确保灾难不会发生的一些预防性措施
- 协助侦测灾难的一些检测性措施
- 灾后实现恢复的一些纠正性措施

DRP 还应包括

- 灾难恢复站点的场所；
- 及有关灾难恢复站点生产就绪状态的细节信息，即该站点是否已恰当地配备为灾后立即投入运营；
- 以及一个确保重要系统在异地站点得以备份的关键系统及数据的层次化列表。


## 备份、执行与频率

在考虑灾难恢复计划（DRP）的一些关键因素时，确保咱们公司的备份计划不仅要满足业务需求，而且要可靠地保存所有数据，这点极其重要。确保咱们数据的完整性与可用性（CIA 中的 IA）的主要组成部分，是要在通常为灾难恢复站点，或另一物理距离较远场所的异地存储备份。咱们绝不应在本地存储备份，除非这些备份属于冗余副本。

## 冗余与容错

在灾难情形下，备份咱们的数据属于确保某一重大事件后运营连续性的一种方式。然而，为了确保咱们的数据，在常规日常操作中不会丢失或受损，咱们应出于冗余与容错，而配置咱们的系统。

冗余及容错的系统，会包含允许部分失效，而同时仍维持运营连续性与数据完整性的一些，基于硬件及基于软件的机制。构成这些系统类型的设备与特性，可以是以下的任意一些：

- **不间断电源（UPS）** -- UPS 会在外部电源失效时，为计算机和服务器短时供电。UPS 一般都会部署，从而用户可以保存他们的工作并关闭他们的计算机，因为所提供的电力通常不足以维持几分钟的运行时间。在外部发电机或辅助电源被部署了的情形下，那些系统便有时间上线；
- **基于硬件的冗余与容错** —— 部署多套有着数据或备份冗余拷贝的系统，可在故障情形下有所帮助；
- **集群化** —— 服务器集群属于一种避免其中单台服务器故障，会导致整个系统崩溃的单点失效故障的方式。所谓集群化，是将多台计算机，通常是一些服务器，连接在一起作为一个单元的做法。因此当一台服务器崩溃时，其余机器将仍能执行必要操作；
- **负载均衡** —— 当咱们对某一网络上的数据有很高需求时，那么咱们会遇到慢速网络响应时间慢或中断的问题。对多个服务器的负载平衡，可对此有所帮助。负载均衡只是接受请求并发送他们到当前最少被用到的服务器；
+ **独立磁盘冗余阵列 (RAID)** — RAID 的总体目标，是组合某一机器里的驱动器，要么提供在某一驱动器失效情形下的更好可用性，要么提供更好的速度。 RAID 配置有多种类型：
    - `RAID 0` 没有冗余。他会执行数据的块级条带化。（所谓条带化，是指单个数据片被写在写入多个磁盘上，从而在稍后读取时，全部这些单个数据片，将同时从多个磁盘读取，从而极大提升读写时间）。`RAID 0` 需要最少两块磁盘；
    - `RAID 1` 属于终极的冗余。他会执行原始驱动器上数据的 1:1 镜像，到阵列中的每个其他驱动器，从而不仅提升了冗余，还提升了读取时间（而非写入时间）。`RAID 1` 需要最少两块磁盘；
    - `RAID 2` 允许咱们通过奇偶校验重建一块损失的驱动器，并且数据会在位级别被条带化，以提供更好性能。`RAID 2` 需要最少三块磁盘；
    - `RAID 3` 属于带奇偶校验的字节级条带化，但所有奇偶校验位都存储在一块专用的奇偶校验驱动器上。`RAID 3` 需要最少三块磁盘；
    - `RAID 4` 属于块级的条带化，但同样配备了一块专用的奇偶校验驱动器。在阵列中的一块驱动器可以失效，与丢失数据可从奇偶校验驱动器重建方面，这一配置类似于 `RAID 5`；但 `RAID 4` 配置的性能，将高度依赖那块奇偶校验驱动器。`RAID 4` 需要最少三块磁盘；
    - `RAID 5` 属于块级条带化，但具备分布式的奇偶校验，这消除了专用校验驱动器的要求，进而避免了这一配置会造成的性能瓶颈。`RAID 5` 阵列中的某一磁盘可以失效，而其内容可从分布在其余磁盘（每块磁盘都有其他磁盘的校验信息，但没有其本身的）上的校验位重建出来。`RAID 5` 需要最少三块磁盘；
    - `RAID 6` 采用双重的分布式奇偶校验，而属于极强容错。这一配置实现了阵列中两块硬盘的损失与重建；`RAID 6` 通常在最少四块硬盘下用到。`RAID 6` 同样使用块级的条带化。

重要的是要注意，RAID 更关注数据可用性而非数据完整性。RAID 阵列只是确保数据将可用；确保数据不损坏或不丢失，并非 RAID 的主要强项。


## 高可用

应对数据丢失与不可用的另一方法，便是确保高可用。确保高可用的方法有一些，比如运用 `RAID 1` 及 `RAID 5` 两种配置，以及确保系统正常失效，即当这些系统确实失效时，他们应 “开放式” 失效（其中数据仍可用，并因此不安全），还是 “封闭式” 失效（其中数据被锁定而不可用，不过是安全的）？这也被描述为 “失效安全”。

## 冷站点、热站点与暖站点

对于灾难恢复，在咱们的备份计划中，包含一个事件发生后以其为基础开展运营的异地场所十分迫切。这一站点可具备不同级别的服务能力与就绪程度；这些分别被描述为冷站点、热站点和暖站点。

所谓冷站点，属于一种通常仅具备一些基础的包括照明、电力及网络能力等基础设施的建筑物的场所。这些站点类型，通常需要运送硬件和数据进入，以及办公所需的桌椅等其他要求。这是准备最少，而维护开支也最低的站点。

所谓热备站点，是指在设备、数据、电源和连通性等方面，近乎与生产环境的复制品的某一场所。通常只需极少工作即可在这一新站点恢复运营。数据备份通常存储于热备站点。

而温备站点介于两者之间。其通常是个功能完备的生产办公室，但没有最新数据或近期备份。相比热备站点，温备站点需要更长时间准备完全使用，但比冷备站点要短得多。

## 平均恢复时间、平均故障间隔时间、恢复时间目标与恢复点目标

出于业务与问责目的，制定详细描述系统恢复上线的近似或平均时间的计划就非常重要。这类指标称为平均恢复时间（MTTR, mean time to restore）或 mean time to recovery。另一同样重要的指标，是平均故障间隔时间（MTBF）。恢复时间目标（RTO）与恢复点目标（RPO），描述了围绕此类故障的一些情形的快速解决。

所谓 MTTR，就是指咱们的服务或设备在故障后回到在线状态的平均所用时间。显然，8 小时的 MTTR 明显优于 36 小时的 MTTR。

所谓 MTBF，指的是两次系统故障之间的平均时间。这个数字越大越好，表明咱们的系统已经运行了一个更长的时间。这一时间通常是咱们系统模型中的一个预测值。

RTO 表示生产系统在某次灾难或故障后，必须启动并再次运行的时间窗口。

RPO 标识某次灾难或故障后，数据可以丢失的最大时间范围。这通常是指防止数据丢失而所必须维护的高频备份数量（通常在某一热备站点处）。低频的备份会导致数据丢失，因为系统可能在备份后及新数据已产生期间宕机。高频备份有助于缓解这种情况，并支持严格的一些 RPO。
